# 治理与宪法

<cite>
**本文档中引用的文件**  
- [constitution.md](file://memory/constitution.md)
- [constitution_update_checklist.md](file://memory/constitution_update_checklist.md)
- [plan-template.md](file://templates/plan-template.md)
- [spec-template.md](file://templates/spec-template.md)
- [tasks-template.md](file://templates/tasks-template.md)
- [setup-plan.sh](file://scripts/bash/setup-plan.sh)
- [setup-plan.ps1](file://scripts/powershell/setup-plan.ps1)
- [common.sh](file://scripts/bash/common.sh)
- [common.ps1](file://scripts/powershell/common.ps1)
- [__init__.py](file://src/specify_cli/__init__.py)
- [README.md](file://README.md)
- [spec-driven.md](file://spec-driven.md)
</cite>

## 目录
1. [引言](#引言)
2. [宪法式治理机制](#宪法式治理机制)
3. [核心架构原则](#核心架构原则)
4. [宪法更新流程](#宪法更新流程)
5. [CLI工具中的宪法检查](#cli工具中的宪法检查)
6. [宪法的定制与扩展](#宪法的定制与扩展)
7. [结论](#结论)

## 引言
本项目采用宪法式治理模式，通过可版本控制的规则文档`constitution.md`来约束AI助手的决策和代码生成过程。该治理机制确保所有技术决策和实现方案都符合预定义的架构原则，从而维护系统的整体一致性。宪法文档作为项目的最高指导原则，其地位高于其他开发实践和约定。本文件详细阐述了宪法的核心原则、更新流程、执行机制以及团队如何根据项目演进进行定制和扩展。

## 宪法式治理机制

宪法式治理是一种通过可版本控制的规则文档来约束AI助手行为的治理模式。在本项目中，`memory/constitution.md`文件定义了所有必须遵守的架构原则和开发规范，这些原则构成了项目的技术DNA。每当AI助手生成代码或制定实施计划时，都必须验证其决策是否符合宪法要求。

这种治理模式的关键优势在于：
- **一致性保障**：确保所有生成的代码和设计决策遵循统一的架构原则
- **可追溯性**：所有技术决策都可以追溯到具体的宪法条款
- **自动化执行**：通过CLI工具和模板实现自动化的合规性检查
- **持续演进**：宪法本身可以通过正式流程进行更新和改进

宪法的执行贯穿于整个开发流程，从`/specify`命令创建功能规范，到`/plan`命令生成实施计划，再到`/tasks`命令分解任务，每个阶段都会进行宪法合规性检查。

**Section sources**
- [constitution.md](file://memory/constitution.md)
- [spec-driven.md](file://spec-driven.md)

## 核心架构原则

宪法文档定义了九项核心原则，这些原则共同构成了项目的技术基础。以下是关键原则的详细说明：

### 模块化设计（Article I: Library-First）
所有功能必须以独立库的形式开始开发。这一原则强制从一开始就进行模块化设计，确保功能的可重用性和独立测试性。每个库必须有明确的目的，禁止创建仅用于组织目的的库。

### 命令行接口（Article II: CLI Interface）
每个库必须通过命令行接口暴露其功能。接口遵循文本输入/输出协议：输入来自stdin/参数，输出到stdout，错误信息到stderr。支持JSON和人类可读格式，确保系统的可调试性和可观测性。

### 测试先行（Article III: Test-First）
测试驱动开发是不可协商的强制要求。必须遵循严格的红-绿-重构周期：先编写测试 → 用户批准 → 测试失败 → 然后实现。在任何实现代码编写之前，必须先编写并验证单元测试。

### 集成测试优先（Article IV: Integration Testing）
重点关注需要集成测试的领域：新库的合约测试、合约变更、服务间通信和共享模式。测试必须使用真实环境，优先使用真实数据库而非模拟，使用实际服务实例而非存根。

### 可观测性（Article V: Observability）
系统必须具备良好的可观测性。要求结构化日志记录，文本输入/输出协议确保可调试性。所有关键操作必须有日志记录，便于问题排查和性能分析。

### 版本控制与破坏性变更（Article VI: Versioning & Breaking Changes）
采用MAJOR.MINOR.BUILD版本格式。对破坏性变更有严格的管理流程，包括迁移计划和兼容性评估。所有公共API的变更必须经过正式评审。

### 简化原则（Article VII: Simplicity）
遵循YAGNI（You Aren't Gonna Need It）原则，从简单开始。初始实现最多允许3个项目，额外项目需要充分的理由。禁止过度工程化和未来主义设计。

### 反抽象原则（Article VIII: Anti-Abstraction）
直接使用框架特性而非包装它们。避免不必要的抽象层，保持代码的直接性和可理解性。单一模型表示，不创建多余的DTO或ViewModel。

### 集成优先测试（Article IX: Integration-First Testing）
测试必须使用真实环境，优先进行合约测试。在实现之前必须定义合约并编写合约测试。真实依赖优于模拟，确保代码在实际环境中工作。

**Section sources**
- [constitution.md](file://memory/constitution.md)
- [spec-driven.md](file://spec-driven.md)

## 宪法更新流程

宪法的更新遵循严格的流程，确保所有相关文档保持同步。更新流程由`memory/constitution_update_checklist.md`文件定义，包括以下关键步骤：

### 模板更新
当修改任何宪法条款时，必须同步更新相关模板：
- `/templates/plan-template.md` - 更新宪法检查部分
- `/templates/spec-template.md` - 如果影响需求/范围则更新
- `/templates/tasks-template.md` - 如果需要新任务类型则更新
- `/.claude/commands/plan.md` - 如果规划流程变更则更新
- `/.claude/commands/tasks.md` - 如果任务生成受影响则更新
- `/CLAUDE.md` - 更新运行时开发指南

### 特定条款更新
不同宪法条款的更新需要特定的同步操作：
- **Article I (Library-First)**：确保模板强调库创建，更新CLI命令示例
- **Article II (CLI Interface)**：更新模板中的CLI标志要求，添加文本I/O协议提醒
- **Article III (Test-First)**：更新所有模板中的测试顺序，强调TDD要求
- **Article IV (Integration Testing)**：列出集成测试触发器，更新测试类型优先级
- **Article V (Observability)**：在模板中添加日志要求，包括多层日志流
- **Article VI (Versioning)**：添加版本递增提醒，包括破坏性变更程序
- **Article VII (Simplicity)**：更新项目数量限制，添加模式禁止示例

### 验证步骤
1. **提交前验证**：
   - 所有模板引用新要求
   - 示例更新以匹配新规则
   - 文档间无矛盾

2. **模板更新后验证**：
   - 通过样本实施计划进行验证
   - 确认所有宪法要求都已解决
   - 检查模板是否自包含（无需宪法即可阅读）

3. **版本跟踪**：
   - 更新宪法版本号
   - 在模板页脚注明版本
   - 在宪法历史中添加修订记录

### 常见遗漏
注意这些经常被忽略的更新：
- 命令文档 (`/commands/*.md`)
- 模板中的检查清单项
- 示例代码/命令
- 领域特定变体（Web vs 移动 vs CLI）
- 文档间的交叉引用

**Section sources**
- [constitution_update_checklist.md](file://memory/constitution_update_checklist.md)
- [spec-driven.md](file://spec-driven.md)

## CLI工具中的宪法检查

CLI工具在`/plan`等命令中执行宪法检查，防止违反架构原则的设计方案。检查机制通过模板和脚本实现，确保所有生成的实施计划都符合宪法要求。

### `/plan`命令中的宪法检查
`/plan`命令的执行流程中包含多个宪法检查点：

```mermaid
flowchart TD
A[加载功能规范] --> B[填充技术上下文]
B --> C[填充宪法检查部分]
C --> D{评估宪法检查}
D --> |存在违规| E[记录在复杂度跟踪中]
D --> |无法简化| F[错误 "先简化方法"]
D --> |通过| G[执行阶段0 → research.md]
G --> H{仍有未知项?}
H --> |是| I[错误 "解决未知项"]
H --> |否| J[执行阶段1 → 合约, 数据模型等]
J --> K{重新评估宪法检查}
K --> |新违规| L[重构设计, 返回阶段1]
K --> |通过| M[计划阶段2 → 任务生成方法]
M --> N[停止 - 准备好/taks命令]
```

**Diagram sources**
- [plan-template.md](file://templates/plan-template.md)
- [setup-plan.sh](file://scripts/bash/setup-plan.sh)
- [setup-plan.ps1](file://scripts/powershell/setup-plan.ps1)

### 检查机制实现
宪法检查通过以下方式实现：
1. **模板驱动**：`plan-template.md`中的"宪法检查"部分根据宪法内容动态填充
2. **阶段门控**：在关键阶段设置检查点，如初始宪法检查和设计后宪法检查
3. **复杂度跟踪**：当存在必须违反宪法的情况时，必须在"复杂度跟踪"表中记录原因和被拒绝的更简单替代方案

### 脚本支持
Bash和PowerShell脚本提供基础支持：
- `scripts/bash/setup-plan.sh` 和 `scripts/powershell/setup-plan.ps1`：设置实施计划的脚本
- `scripts/bash/common.sh` 和 `scripts/powershell/common.ps1`：通用函数和变量

这些脚本确保在创建新功能时，正确的模板被复制到适当位置，为宪法检查提供基础。

**Section sources**
- [plan-template.md](file://templates/plan-template.md)
- [setup-plan.sh](file://scripts/bash/setup-plan.sh)
- [setup-plan.ps1](file://scripts/powershell/setup-plan.ps1)
- [common.sh](file://scripts/bash/common.sh)
- [common.ps1](file://scripts/powershell/common.ps1)

## 宪法的定制与扩展

宪法作为活文档，可以根据项目演进进行定制和扩展。以下是团队如何有效管理宪法的指导原则：

### 定制原则
1. **保持核心稳定**：基本架构原则（如测试先行、模块化设计）应保持稳定
2. **领域特定扩展**：根据项目领域添加特定要求，如安全标准、性能目标
3. **渐进式改进**：通过小步迭代改进宪法，而非大规模重构

### 扩展流程
1. **识别需求**：当现有宪法无法有效指导决策时，识别扩展需求
2. **提案与评审**：提出宪法修改提案，经过团队评审
3. **影响评估**：评估修改对现有项目和流程的影响
4. **实施与同步**：更新宪法并同步所有相关模板和文档
5. **培训与沟通**：确保团队成员了解新规则

### 最佳实践
- **定期审查**：每季度审查宪法的有效性
- **案例学习**：从实际项目中收集经验教训，改进宪法
- **工具支持**：利用CLI工具自动化宪法检查
- **文档同步**：确保所有相关文档与宪法保持同步

宪法的灵活性使其能够适应项目的发展，同时保持技术一致性。通过正式的更新流程，团队可以在创新和稳定性之间取得平衡。

**Section sources**
- [constitution.md](file://memory/constitution.md)
- [constitution_update_checklist.md](file://memory/constitution_update_checklist.md)
- [spec-driven.md](file://spec-driven.md)

## 结论
宪法式治理通过可版本控制的规则文档为项目提供了坚实的技术基础。`constitution.md`中定义的架构原则确保了所有AI生成的代码和设计决策都符合预定义的标准，维护了系统的整体一致性。通过严格的更新流程和CLI工具中的自动检查，宪法不仅是一份静态文档，而是一个活的、可演进的治理机制。团队应将宪法视为项目的核心资产，定期审查和改进，以适应不断变化的需求和技术环境。这种治理模式不仅提高了代码质量，还促进了团队间的共识和协作。